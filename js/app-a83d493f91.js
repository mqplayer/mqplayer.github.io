function isEmpty(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function getParameterByName(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return null==n?"":decodeURIComponent(n[1].replace(/\+/g," "))}function gapi_loaded(){gapi.client.load("drive","v2",function(){gapi_loaded_deferred.resolve()})}Array.prototype.empty=function(){this.splice(0,this.length)},Array.prototype.pushArray=function(e){Array.prototype.push.apply(this,e)},Array.prototype.spliceArray=function(e,t,n){Array.prototype.splice.apply(this,[e,t].concat(n))},Array.prototype.remove=function(e){if(Array.isArray(e)){var t=this;e.forEach(function(e){t.remove(e)})}else{var n=this.indexOf(e);-1!==n&&this.splice(n,1)}},Array.prototype.add=function(e){-1===this.indexOf(e)&&this.push(e)},Array.prototype.clone=function(){return this.slice(0)},Array.prototype.shuffle=function(){for(var e,t,n=this.length;n>0;)t=Math.floor(Math.random()*n),n--,e=this[n],this[n]=this[t],this[t]=e;return this},Array.prototype.rotate=function(e){return this.unshift.apply(this,this.splice(e,this.length)),this};var isFF=navigator.userAgent.toLowerCase().indexOf("firefox")>-1;Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),angular.module("types",[]),angular.module("services",["types"]),angular.module("directives",["types","services","ui.slider"]),angular.module("app",["ngRoute","directives","services","types","ui.bootstrap"]),angular.module("app").run(["$templateCache","$http",function(e,t){t.get("partials/accounts.html",{cache:e})}]),angular.module("app").config(["$provide",function(e){e.decorator("$q",["$delegate",function(e){var t=e;return t.allSettled=t.allSettled||function(e){var n=t.defer();if(!angular.isArray(e))throw"allSettled can only handle an array of promises (for now)";var r=[],o=[],i=!1;angular.forEach(e,function(e,t){r[t]=!1});var a=function(e,t,n,r){var o=!0;angular.forEach(e,function(e,t){e||(o=!1)}),o&&(r?n.reject(t):n.resolve(t))};return angular.forEach(e,function(e,s){t.when(e).then(function(e){r[s]=!0,o[s]=e,a(r,o,n,i)},function(e){r[s]=!0,o[s]=e,i=!0,a(r,o,n,i)})}),n.promise},t.one=function(e){var n=t.defer();if(!angular.isArray(e))throw"allSettled can only handle an array of promises (for now)";var r=[],o=[],i=!1;angular.forEach(e,function(e,t){r[t]=!1});var a=function(){var e=!0;angular.forEach(r,function(t,n){t||(e=!1)}),e&&(i?n.resolve(o):n.reject(o))};return angular.forEach(e,function(e,n){t.when(e).then(function(e){r[n]=!0,o[n]=e,i=!0,a()},function(e){r[n]=!0,o[n]=e,a()})}),n.promise},t}])}]),angular.module("services").factory("columnResizer",["$document",function(e){var t,n,r,o,i,a,s,c,u,l,d=function(u){u.preventDefault();var l=$(u.target);i="resize-bar-left"==l.attr("id"),o=$(i?"#left-col":"#right-col"),a=$("#content-col"),t=o.outerWidth(),s=a.outerWidth(),r=parseInt(o.css("min-width")),c=parseInt(a.css("min-width")),n=u.pageX,e.on("mousemove",f),e.on("mouseup",p)},f=function(e){var d=e.pageX-n,f=s+(i?-1:1)*d,p=t+(i?1:-1)*d;c>f||r>p||(i?(u=t+d,h(a,o,u)):(l=t-d,g(a,o,l)))},p=function(){e.off("mousemove",f),e.off("mouseup",p)},h=function(e,t,n){t.css("width",n+"px"),e.css("margin-left",n+"px")},g=function(e,t,n){t.css("width",n+"px"),t.css("margin-left","-"+n+"px"),e.css("margin-right",n+"px")},m=function(){var e=$("#content-col"),t=$("#left-col"),n=$("#right-col");h(e,t,u),g(e,n,l)};return{mousedown:d,restore:m}}]),angular.module("app").controller("AppController",["$scope","$location","$timeout","session","page","helper","clients","$document","$route","$rootScope","$modal",function(e,t,n,r,o,i,a,s,c,u,l){a.available().forEach(function(e){a.load(e.name)}),e.page=o,e.session=r,e.login=function(t){r.login(t),e.closeMenuWidget()},e.logout=function(t){r.logout(t),e.closeMenuWidget()},e.showMessage=function(t,n){e.messageText=t,e.messageType=n},e.hideMessage=function(){e.messageText=""},e.error=function(t){e.showMessage(t,"error")},e.currentMenuWidget=null,e.isMenuWidgetOpen=function(t){return e.currentMenuWidget==t},e.toggleMenuWidget=function(t){e.currentMenuWidget=e.currentMenuWidget==t?null:t},e.closeMenuWidget=function(){e.toggleMenuWidget(null)},u.$on("keydown",function(t,n){27==n&&(e.closeMenuWidget(),e.hideMessage())}),e.toggleAccounts=function(t){e.accountsOpen=void 0!==t?t:!e.accountsOpen},$(document).on("mousedown",function(t){0===$(t.target).parents(".dropdown").length&&e.$apply(function(){e.closeMenuWidget()})}),$(document).on("click.bs.dropdown.data-api",".accounts button",function(t){e.$apply(function(){e.toggleAccounts(!1)})}),e.mousedown=function(){e.hideMessage(),e.$emit("mousedown")},e.keydown=function(t){e.$emit("keydown",t.keyCode)},e.savePlaylistDialog=function(t){var n=l.open({animation:!1,templateUrl:"tmpl/save-playlist-modal.html",scope:e,controller:"SavePlaylistController",resolve:{playlist:function(){return t}}});n.rendered.then(function(){$("#save-playlist-name").focus()})}}]),angular.module("app").controller("AccountsController",["$scope","clients","helper",function(e,t,n){e.loading=!0,e.services=t.available().map(function(e){var r={name:e.name,title:e.title,loggedIn:t.isLoggedIn(e.name)};if(r.loggedIn){var o=t[r.name];if(r.user=o.user.email||o.user.name,o.user.quota&&void 0!==o.user.used){var i=Math.floor(o.user.used/o.user.quota*100);r.stats=n.formatBytes(o.user.used)+" ("+i+"%) of "+n.formatBytes(o.user.quota)+" used"}}return r}),e.loading=!1}]),angular.module("app").controller("PlaylistManagerController",["$scope","PlaylistService","session","clients","Item","Record","$q",function(e,t,n,r,o,i,a){function s(){e.loading=!0,l.loadPlaylists()["finally"](function(){e.loading=!1})}var c=n.playlist,u=n.player,l=e.playlistManager=n.playlistManager;e.select=function(e){e.selected=!e.selected},e.selected=function(){return l.playlists.filter(function(e){return e.selected})},e.play=function(n){e.loading=!0,t.getRecords(n.id).then(function(t){c.clear();var n=t.map(function(e){var t=new o(r[e.account.service],e.id,e.name,"file",e.url);return new i(t,e.account)});c.set(n).then(function(){var t,n=[],r=c.getRecords();if(r.forEach(function(e){var r=e.item.client;-1===n.indexOf(r)&&n.push(r),!t&&r.isLoggedIn()&&(t=e)}),r.length)if(t)u.playRecord(t)["catch"](function(t){e.error(t)});else if(n.length){var o;o=n.length>1?"To play records from this playlist you have to be logged in to the following services: "+n.map(function(e){return e.title}).join(", "):"You have to be logged in to "+n[0].title+" to play records from this playlist.",e.error(o)}})})["finally"](function(){e.loading=!1})},e.enqueue=function(n){e.loading=!0,t.getRecords(n.id).then(function(e){var t=e.map(function(e){var t=r[e.account.service],n=new o(t.isLoggedIn()&&t.user.email==e.account.email?t:null,e.id,e.name,"file",e.url);return new i(n,e.account)});c.enqueue(t)})["finally"](function(){e.loading=!1})},e.remove=function(n){var r;if(r=n?[n]:l.playlists.filter(function(e){return e.selected}),r.length){e.loading=!0;var o=r.map(function(e){return e.id});t["delete"](o).then(function(){l.playlists.remove(r)})["finally"](function(){e.loading=!1})}},s()}]),angular.module("app").controller("PlaylistController",["$scope","$document","$timeout","session","Record","helper","$rootScope",function(e,t,n,r,o,i,a){function s(e){l.selectedRecords.forEach(function(e){e.selected=!1}),l.selectedRecords.empty(),e.selected=!e.selected,e.selected&&l.selectedRecords.push(e)}function c(t){switch(t.keyCode){case 46:e.deleteSelected();break;case 65:t.ctrlKey&&e.selectAll();break;case 38:h(t);break;case 40:g(t);break;default:return}n(angular.noop),t.preventDefault(),t.stopPropagation()}var u=r.player,l=r.playlist,d=r.tree;e.player=u,e.playlist=l,this.getScope=function(){return e};var f;e.deleteSelected=function(){l.removeSelected()},e.selectAll=function(){l.selectedRecords.empty(),l.records.forEach(function(e){e.selected=!0,l.selectedRecords.push(e)})},e.clear=function(){l.clear()};var p=function(){l.selectedRecords.forEach(function(e){e.selected=!1}),l.selectedRecords.empty()},h=function(t){var n=l.prev(f,!1,!1);n&&e.mousedown(t,n)},g=function(t){var n=l.next(f,!1,!1);n&&e.mousedown(t,n)};e.dblclick=function(t,r){a.$broadcast("player.timeupdate",0),n(function(){l.rotateShuffledRecords(r),u.playRecord(r)["catch"](function(t){e.error(t)})})};var m;e.mousedown=function(e,t){if(!t)return void("playlist"===e.target.id&&p());if(e.shiftKey){if(f&&f.selected!=t.selected)for(var n=l.records.indexOf(f),r=l.records.indexOf(t),o=r>n?n+1:r,i=r>n?r:n-1,a=o;i>=a;a++)l.records[a].selected=f.selected,l.selectedRecords.push(l.records[a])}else if(e.ctrlKey){if(t.selected){var a=l.selectedRecords.indexOf(t);l.selectedRecords.splice(a,1)}else l.selectedRecords.push(t);t.selected=!t.selected}else m=void 0,-1===l.selectedRecords.indexOf(t)?s(t):m=t;f=t},e.mouseup=function(e,t){m&&(s(m),m=void 0)},t.on("keydown",c),e.$on("$destroy",function(){t.off("keydown",c)}),e.$on("dragstart",function(t){e.dragging=!0}),e.$on("dragend",function(t){e.dragging=!1}),e.$on("dragenter",function(t){var n=t.targetScope;e.$apply(function(){n==e?n.dragover=!0:n.record.dragover=!0})}),e.$on("dragleave",function(t){var n=t.targetScope;e.$apply(function(){n==e?n.dragover=!1:n.record.dragover=!1})}),e.$on("drop",function(t){var n=t.targetScope;e.$apply(function(){var t;e!=n&&(t=n.record),e.dragging?l.move(l.selectedRecords,t):l.enqueue(i.getItemRecords(d.draggedNode.item),t),t?t.dragover=!1:n.dragover=!1})})}]),angular.module("app").controller("SavePlaylistController",["$scope","$modalInstance","session","PlaylistService","playlist",function(e,t,n,r,o){function i(e,t){return r.update(e.id,t).then(function(){e.name=t})}function a(e){var t=n.playlist.records.slice(0,999).map(function(e,t){return{accountId:e.account.id,id:e.item.id,name:e.item.name,url:e.item.getUrl(!0),order:t}});return r.create(e,t).then(function(e){n.playlistManager.playlists.add(e)})}e.title=o?"Edit playlist":"Save playlist",o&&(e.name=o.name),e.ok=function(n){if(n){e.loading=!0;var r=o?i(o,n):a(n);return r.then(function(){t.close()})["finally"](function(){e.loading=!1})}},e.cancel=function(){t.dismiss("cancel")},e.saveKeydown=function(t){27!=t.keyCode&&(13==t.keyCode&&e.ok(e.name),t.stopPropagation())}}]),angular.module("app").controller("HomeController",["$scope","session","columnResizer",function(e,t,n){void 0===t.loggedIn()&&t.autoLogin(),e.resizeBarMousedown=n.mousedown,e.restoreBarWidths=function(){n.restore()}}]),angular.module("app").controller("OpenFromDriveController",["$scope","session","$location","$timeout","helper","clients",function(e,t,n,r,o,i){function a(){n.replace(),n.url("/")}function s(e){return t.playlist.set(o.getRecordsByItemIds(i.drive,e)).then(function(e){e.length>0&&t.player.playRecord(e[0])})["catch"](function(e){})}function c(){var e,t=getParameterByName("state");if(t){try{e=angular.fromJson(decodeURI(t))}catch(n){return void console.log("Error parsing the state parameter: "+n)}if(e.ids&&e.ids.length>0)return e.ids}}e.loading=!0;var u=c();return u?(t.autoLogin().then(function(){i.drive.isLoggedIn()&&(s(u),a())})["finally"](function(){e.loading=!1}),e.login=function(){t.login("drive").then(function(){s(u),a()})},void(e.cancel=function(){a()})):void a()}]),function(){var e,t=["clients","$q",function(t,n){return e||t.available().forEach(function(n){var r=t.load(n.name);e=e?e.then(function(){return r}):r}),e}];angular.module("app").config(["$routeProvider","$locationProvider",function(e,n){e.when("/",{templateUrl:"partials/home.html",controller:"HomeController",resolve:{loadClients:t}}),e.when("/drive",{templateUrl:"partials/openFromDrive.html",controller:"OpenFromDriveController",resolve:{loadClients:t}}),e.when("/help",{templateUrl:"partials/help.html"}),e.otherwise({redirectTo:"/"}),n.html5Mode(!0)}])}(),angular.module("types").factory("Playlist",["Record","$q",function(e,t){function n(){this.repeat=!1,this.random=!1,this.records=[],this.shuffledRecords=[],this.selectedRecords=[],this.loading=!1}return n.prototype={enqueue:function(e,n){this.loading=!0;var r=this,o=n?this.records.indexOf(n):this.records.length;return t.when(e).then(function(e){return e.forEach(function(e){r.records.splice(o++,0,e)}),r.shuffle(),r.records})["finally"](function(){r.loading=!1})},set:function(e){return this.clear(),this.enqueue(e)},clear:function(){this.records.empty(),this.selectedRecords.empty(),this.shuffle()},removeSelected:function(){var e=this;this.selectedRecords.length==this.records.length?this.records.empty():this.selectedRecords.forEach(function(t){var n=e.records.indexOf(t);e.records.splice(n,1)}),this.selectedRecords.empty(),this.shuffle()},prev:function(e,t,n){var r=(void 0===t?this.random:t)?this.shuffledRecords:this.records,o=r.indexOf(e);return o>0?r[o-1]:0===o&&(void 0===n?this.repeat:n)?r[r.length-1]:!1},next:function(e,t,n){var r=(void 0===t?this.random:t)?this.shuffledRecords:this.records,o=r.indexOf(e);return o<=r.length-2?r[o+1]:o===r.length-1&&(void 0===n?this.repeat:n)?r[0]:!1},toggleRandom:function(){this.random=!this.random,this.currentRecord&&this.rotateShuffledRecords(this.currentRecord)},toggleRepeat:function(){this.repeat=!this.repeat},selectAll:function(){var e=this;this.selectedRecords.empty(),this.records.forEach(function(t){t.selected=!0,e.selectedRecords.push(t)})},move:function(e,t){var n=this;t&&-1!==e.indexOf(t)||(e.forEach(function(e){n.records.splice(n.records.indexOf(e),1)}),n.records.spliceArray(t?n.records.indexOf(t):n.records.length,0,e))},shuffle:function(){this.shuffledRecords=this.records.clone().shuffle()},rotateShuffledRecords:function(e){this.shuffledRecords.rotate(this.shuffledRecords.indexOf(e))},getRecords:function(){return this.random?this.shuffledRecords:this.records}},n}]),angular.module("types").factory("Record",function(){function e(e,t){this.item=e,this.selected=!1,this.account=t}return e}),angular.module("types").factory("Player",["$rootScope","$q","page","clients",function(e,t,n,r){function o(){this.audio=new Audio,this.volumeStep=.05,this.audio.volume=.5,this.state="stopped",this.currentTime=0,this.currentRecord=void 0;var t=this;this.audio.addEventListener("ended",function(){e.$broadcast("player.trackended")}),this.audio.addEventListener("loadedmetadata",function(){t.loadedmetadata&&t.loadedmetadata()}),this.audio.addEventListener("timeupdate",function(n){e.$broadcast("player.timeupdate",t.audio.currentTime)})}return o.prototype={setTime:function(e){this.audio.currentTime=e},playRecord:function(o){var i=t.defer(),a=this;return this.stop(),o.item.client&&o.item.client.isLoggedIn()?(this.state="buffering",e.$broadcast("player.timeupdate",0),this.audio.pause(),this.audio.src="",this.currentRecord=o,o.item.getUrl().then(function(e){a.loadedmetadata=function(){a.audio.play(),a.state="playing",i.resolve()},a.audio.src=e,n.setTitle(o.item.name)})["catch"](function(e){console.log("Failed to get file url: "+e),a.stop()})):i.reject("You have to be logged in to "+r[o.account.service].title+" as "+o.account.email+" to play this record ("+o.item.name+")."),i.promise},stop:function(){this.audio.pause(),this.audio.src="",this.currentRecord=void 0,this.state="stopped",n.setTitle()},isPaused:function(){return this.audio.paused},play:function(){this.audio.play(),this.state="playing"},pause:function(){this.audio.pause(),this.state="paused"},mute:function(){this.audio.muted=!this.audio.muted},volumeUp:function(){this.audio.volume+this.volumeStep<=1&&(this.audio.volume+=this.volumeStep)},volumeDown:function(){this.audio.volume-this.volumeStep>=0&&(this.audio.volume-=this.volumeStep)}},o}]),angular.module("types").factory("Tree",["TreeNode",function(e){function t(){this.roots=[],this.selected=void 0,this.selectedNode=void 0,this.draggedNode=void 0}return t.prototype={},t}]),angular.module("types").factory("TreeNode",function(){function e(e){this.item=e,this.collapsed=!0,this.selected=!1,this.loading=!1,this.children=void 0}return e.prototype={getChildren:function(){if(!this.childrenPromise){var t=this;this.loading=!0,this.childrenPromise=this.item.getChildren().then(function(n){return t.children=n.map(function(t){var n=new e(t);return n}),t.empty=0===n.length,t.children})["catch"](function(){})["finally"](function(){t.loading=!1})}return this.childrenPromise}},e}),angular.module("types").factory("Item",["$q",function(e){function t(e,t,n,r,o,i,a){this.client=e,this.id=t,this.name=n,this.type=r,this.url=o,this.parentid=i,this.shared=a}return t.sort=function(e,t){return e.type===t.type?e.name<t.name?-1:1:"dir"===e.type?-1:1},t.prototype={getUrl:function(t){if(t)return"function"==typeof this.client.getFileUrl?this._url:this.url;var n=this;return"function"==typeof this.client.getFileUrl?this._url?e.when(this._url):this.client.getFileUrl(n.id).then(function(e){return n._url=e,e}):e.when(this.url)},getChildren:function(){return this.client.getItemsByParent(this.id)},getAllChildren:function(t){return this.getChildren().then(function(t){var n=[],r=[];t.forEach(function(e){n.push(e),"dir"==e.type&&r.push(e)});var o=e.when(n);return r.forEach(function(e){o=o.then(function(){return e.getAllChildren().then(function(t){return Array.prototype.splice.apply(n,[n.indexOf(e),1].concat(t)),n})})}),o})}},t}]),angular.module("types").factory("Drive",["$http","$q","$timeout","Item","$interval",function(e,t,n,r,o){function i(){this.user={}}var a,s,c,u="97071318931-0pqadkdeov03b36bhthnri1n3h64eg7d.apps.googleusercontent.com",l=["https://www.googleapis.com/auth/drive.readonly"],d={};return i.prototype={_getItem:function(e){var t="application/vnd.google-apps.folder"===e.mimeType?"dir":"file",n=e.sharedWithMeDate?!0:!1,o="file"===t?e.downloadUrl+"&access_token="+encodeURIComponent(this.token):void 0,i=n?void 0:e.parents&&e.parents[0].id;return new r(this,e.id,e.title,t,o,i,n)},_getItems:function(e){var n=this,o=t.defer(),i=0,a=function(t,r){t.execute(function(s){if(s.error)if(401==s.error.code&&1>i)console.log(new Date,"Refreshing the token..."),n._refreshToken().then(function(){a(t,r)})["catch"](function(){var e=s.error.code+" "+s.error.message;o.reject("Failed to refresh token:"+e),console.log(e)}),i++;else{var c=s.error.code+" "+s.error.message;o.reject(c),console.log(c)}else s.items&&(r=r.concat(s.items)),s.nextPageToken?(t=gapi.client.drive.files.list({q:e,pageToken:s.nextPageToken}),a(t,r)):o.resolve(r)})},s=gapi.client.drive.files.list({q:e});return a(s,[]),o.promise.then(function(e){var t=e.map(function(e){return n._getItem(e)});return t.sort(r.sort),t})},login:function(e){var n=t.defer(),r=this;return gapi.auth.authorize({client_id:u,scope:l.join(" "),immediate:e||!1},function(e){if(e&&!e.error)a=!0,s=gapi.auth.getToken(),r.token=s.access_token,n.resolve();else{a=!1;var t=e&&e.error;n.reject(t)}}),n.promise.then(function(){return r._getUserInfo()})},_refreshToken:function(){var e=t.defer();return gapi.auth.authorize({client_id:u,scope:l.join(" "),immediate:!0},function(t){t.error?e.reject(t.error.code+" "+t.error.message):e.resolve()}),e.promise},logout:function(){d={};var t="https://accounts.google.com/o/oauth2/revoke?token="+s.access_token+"&callback=JSON_CALLBACK";return e.jsonp(t)["catch"](function(){})["finally"](function(){a=!1})},_getUserInfo:function(){if(!c){var e=t.defer(),n=this;gapi.client.drive.about.get().execute(function(t){t.error?e.reject(t.error.code+" "+t.error.message):(n.user.name=t.name,n.user.email=t.user.emailAddress,n.user.quota=t.quotaBytesTotal,n.user.used=t.quotaBytesUsedAggregate,e.resolve(n.user))}),c=e.promise}return c},getItemsByParent:function(e){if(!d[e]){e||(e="root");var t="'"+e+"' in parents";"root"===e&&(t="(sharedWithMe or "+t+")"),t+=" and trashed = false",d[e]=this._getItems(t)}return d[e]},getItemById:function(e){var n=t.defer(),r=this,o=gapi.client.drive.files.get({fileId:e});return o.execute(function(e){if(e.error){var t=e.error.code+" "+e.error.message;n.reject(t),console.log(t)}else n.resolve(r._getItem(e))}),n.promise},isLoggedIn:function(){return a}},i}]),angular.module("types").factory("DropboxClient",["$http","$q","$timeout","Item","$location",function(e,t,n,r,o){function i(){a=new Dropbox.Client({key:l});var e=o.protocol()+"://"+o.host()+"/dropbox_oauth.html";a.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:e})),this.user={}}var a,s,c,u,l="qfd1sjynxut1kkw",d={};return i.prototype={_getItem:function(e){var t=e.isFolder?"dir":"file";return new r(this,e.path,e.name,t,void 0,void 0,!1)},login:function(e){var n=this;return c=t.defer(),u||(u=function(e,t){t.isAuthenticated()?(n.token=a._oauth._token,c.resolve()):c.reject(e)}),a.authenticate({interactive:!e},function(e,t){u&&(u(e,t),u=void 0)}),c.promise.then(function(){return n._getUserInfo()})},logout:function(){var e=t.defer();return d={},a.signOut(function(){e.resolve()}),e.promise},_getUserInfo:function(){if(!s){var e=t.defer(),n=this;a.getAccountInfo(function(t,r){t?e.reject(t):(n.user.name=r.name,n.user.email=r.email,n.user.quota=r.quota,n.user.used=r.usedQuota,e.resolve())}),s=e.promise}return s},getItemsByParent:function(e){if(!d[e]){e||(e="");var n=this,o=t.defer();a.readdir(e,function(e,t,i,a){e&&o.reject(e);var s=a.map(function(e){return n._getItem(e)});s.sort(r.sort),o.resolve(s)}),d[e]=o.promise}return d[e]},getFileUrl:function(e){var n=t.defer();return a.makeUrl(e,{download:!0},function(e,t){e?n.reject(e):n.resolve(t.url)}),n.promise},isLoggedIn:function(){return a.isAuthenticated()}},i}]),angular.module("types").factory("PlaylistManager",["PlaylistService",function(e){function t(){this.playlists=[]}return t.prototype={loadPlaylists:function(){var t=this;return e.list().then(function(e){return t.playlists=e,e})}},t}]),angular.module("services").factory("helper",["$q","Record","appData","Item","clients",function(e,t,n,r,o){var i={};return i.isSupportedType=function(e){return/\.mp3/.test(e)},i.getItemRecords=function(n){return("file"==n.type?e.when([n]):n.getAllChildren()).then(function(e){var n=[];return e.forEach(function(e){"file"==e.type&&i.isSupportedType(e.name)&&n.push(new t(e,e.client.account))}),n})},i.getRecordsByItemIds=function(t,n){return t.getItemById(n[0]).then(function(r){return 1===n.length?i.getItemRecords(r):t.getItemsByParent(r.parentid).then(function(t){var r=[];t.forEach(function(e){-1!==n.indexOf(e.id)&&r.push(e)});var o=[],a=e.when(o);return r.forEach(function(e){a=a.then(function(){return i.getItemRecords(e).then(function(e){return o.pushArray(e),o})})}),a})})},i.formatBytes=function(e,t){var n=t?1e3:1024;if(n>e)return e+" B";var r=["kB","MB","GB","TB","PB","EB","ZB","YB"],o=-1;do e/=n,++o;while(e>=n);return e.toFixed(2)+" "+r[o]},i}]),angular.module("app").factory("page",function(){var e="MQ Player";return{title:function(){return e},setTitle:function(t){e=t||"MQ Player"}}}),angular.module("services").factory("session",["$q","Player","Playlist","Tree","page","helper","clients","TreeNode","Item","appData","api","PlaylistManager",function(e,t,n,r,o,i,a,s,c,u,l,d){function f(){v.playlist=new n,v.tree=new r,v.player=new t,v.active=!0,v.playlistManager=new d}function p(e){var t=new s(new c(e,"",e.title,"root"));return t.getChildren(),t.collapsed=!1,t}function h(){v.active=!1,v.player.stop(),v.player=void 0,v.tree=void 0,v.playlist=void 0,v.playlistManager=void 0,o.setTitle();var t=e.defer();t.reject(),m=t.promise}function g(){function e(){var e=getParameterByName("state");if(e){var t=angular.fromJson(decodeURI(e));t.ids&&t.ids.length>0&&v.playlist.set(i.getRecordsByItemIds(a.drive,t.ids)).then(function(e){e.length>0&&v.player.playRecord(e[0])})["catch"](function(e){})}}a.drive.isLoggedIn()?e():v.login("drive",!0).then(function(){e()})}var m,v={active:void 0,state:{},loading:!1};return v.login=function(e,t){return a.load(e).then(function(n){return n.login(t).then(function(){return l.login(n.name,n.token).then(function(e){n.account=e})}).then(function(){v.active||f(),v.tree.roots.push(p(n)),u.services.add(e),u.save()})}).then(function(){g()})},v.autoLogin=function(){if(!m){var t=u.services,n=[];t.length>0?(t.forEach(function(e){n.push(a.load(e).then(function(e){return e.login(!0).then(function(){return l.login(e.name,e.token).then(function(t){e.account=t})})}))}),m=e.one(n).then(function(e){f(),a.get(!0).forEach(function(e){v.tree.roots.push(p(e))})})["catch"](function(t){return v.active=!1,e.reject(t)})):(v.active=!1,m=e.reject())}return m},v.logout=function(t){var n;if(t)n=a[t].logout()["finally"](function(){if(u.services.remove(t),u.save(),a.get(!0).length>0){for(var e=0;e<v.tree.roots.length;e++)if(v.tree.roots[e].item.client===a[t]){v.tree.roots.splice(e,1);break}}else h()});else{var r=[];a.get(!0).forEach(function(e){r.push(e.logout())}),n=e.allSettled(r).then(function(){h(),u.services=[],u.save()})}return n},v.loggedIn=function(){return v.active},v}]),angular.module("services").factory("clients",["$q","Drive","DropboxClient",function(e,t,n){var r={},o={drive:{title:"Google Drive","class":t},dropbox:{title:"Dropbox","class":n,api:"//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.3/dropbox.min.js"}},i=[],a={};return r.load=function(t){if(!a[t]){var n=e.defer(),s=o[t];switch(t){case"drive":window.gapi_loaded_deferred=n,$script("//apis.google.com/js/client.js?onload=gapi_loaded");break;default:$script(s.api,function(){n.resolve()})}a[t]=n.promise.then(function(){var e=new s["class"];return e.name=t,e.title=s.title,r[t]=e,i.push(e),r[t]})}return a[t]},r.get=function(e){return e?i.filter(function(e){return e.isLoggedIn()}):i},r.available=function(){var e,t,n=[];for(e in o)t={name:e,title:o[e].title},r[e]&&(t.user=r[e].user.name),n.push(t);return n},r.isLoaded=function(e){return void 0!==r[e]},r.isLoggedIn=function(e){return void 0!==r[e]&&r[e].isLoggedIn()},r}]),angular.module("services").factory("appData",function(){var e=window.localStorage,t=["playlists","services"],n={playlists:{},services:[],save:function(){var n=this;t.forEach(function(t){e.setItem(t,angular.toJson(n[t]))})},restore:function(){var n=this;t.forEach(function(t){try{var r=angular.fromJson(e[t]);r&&(n[t]=r)}catch(o){console.log(o)}})}};return n.restore(),n}),angular.module("services").factory("api",["$http","$q","clients",function(e,t,n){var r="/api",o={};return{setAuthHeader:function(){e.defaults.headers.common.Authorization=angular.toJson(o)},addToken:function(e,t){o[e]=t,this.setAuthHeader()},removeToken:function(e){o[e]=void 0,this.setAuthHeader()},request:function(n,o,i){var a,s=t.defer();return a="post"==n?e.post(r+o,i):e[n](r+o),a.success(function(e,t,n,r){s.resolve(e)}).error(function(e,t,n,r){s.reject(e)}),s.promise},get:function(e){return this.request("get",e)},post:function(e,t){return this.request("post",e,t)},"delete":function(e){return this.request("delete",e)},login:function(e,t){var n=this;return this.post("/token",{service:e,token:t}).then(function(r){return n.addToken(e,t),r})}}}]),angular.module("directives").directive("tree",["session","helper",function(e,t){return{restrict:"E",scope:{},controller:["$scope","$element","$timeout",function(n,r,o){var i=e.tree,a=e.player,s=e.playlist;n.tree=i,n.player=a,n.toggleDir=function(e){return e.collapsed=!e.collapsed,e.getChildren()},n.mousedown=function(e,t){i.selectedNode&&(i.selectedNode.selected=!1),i.selectedNode=t,t.selected=!t.selected},n.dblclick=function(e,n){a.stop(),s.set(t.getItemRecords(n.item)).then(function(e){e.length>0&&a.playRecord(s.getRecords()[0]).then(function(){o(angular.noop)})})},n.$on("dragstart",function(e){var t=e.targetScope;i.draggedNode=t.node}),n.$on("dragend",function(e){i.draggedNode=void 0})}],link:function(e,t,n){},templateUrl:"tmpl/tree.html"}}]),angular.module("directives").directive("player",["session",function(e){return{restrict:"E",templateUrl:"tmpl/player.html",controller:["$scope","$timeout","$document",function(t,n,r){function o(r){e.player.playRecord(r).then(function(){n(angular.noop)})["catch"](function(e){t.error(e)})}function i(r){var o=e.playlist,i=e.player;switch(r.keyCode){case 67:t.playPause();break;case 88:case 13:t.stop(),t.playPause();break;case 82:o.toggleRepeat();break;case 83:o.toggleRandom();break;case 77:i.mute();break;case 98:i.volumeDown();break;case 104:i.volumeUp();break;case 37:case 100:t.prev();break;case 39:case 102:t.next();break;default:return}n(angular.noop),r.preventDefault(),r.stopPropagation()}t.session=e,t.state={volume:.5,tratata:99},t.$on("player.trackended",function(e){n(function(){})}),t.$watch("state.currentTime",function(t){e.player&&Math.abs(t-e.player.audio.currentTime)>1&&e.player.setTime(t)}),t.$watch("state.volume",function(t){e.player.audio.volume=t}),t.$on("player.timeupdate",function(e,r){r>0&&t.state.currentTime&&Math.abs(r-t.state.currentTime)<=1||n(function(){t.state.currentTime=Math.round(r)})}),t.prev=function(){var n=e.playlist,r=e.player,i=n.prev(r.currentRecord);i!==!1&&o(i),t.state.currentTime=0},t.next=function(n){var r=e.playlist,i=e.player;if(i.currentRecord){var a=r.next(i.currentRecord);a!==!1?o(a):n&&i.stop(),t.state.currentTime=0}},t.playPause=function(){var t=e.playlist,n=e.player;"paused"==n.state?n.play():"stopped"==n.state?t.selectedRecords.length>0?o(t.selectedRecords[t.selectedRecords.length-1]):t.records.length>0&&o(t.records[0]):n.pause()},t.stop=function(){e.player.stop(),t.state.currentTime=0},t.selectAll=function(){},t.$on("player.trackended",function(e,r){n(function(){t.next(!0)})}),t.toggleShuffle=function(){var t=e.player,n=e.playlist;t.currentRecord&&n.rotateShuffledRecords(t.currentRecord),n.toggleRandom()},r.on("keydown",i),t.$on("$destroy",function(){r.off("keydown",i)})}]}}]),angular.module("directives").directive("resizeBar",["$document","session",function(e,t){var n,r,o,i,a=function(t){t.preventDefault(),n=$("#left").outerWidth(),r=$("#resize-bar").outerWidth(),i=parseInt($("#left").css("min-width")),o=t.pageX,e.on("mousemove",s),e.on("mouseup",c)},s=function(e){var r=e.pageX-o;i>n+r||(u(r),t.state.sidebarWidth=r)},c=function(){e.off("mousemove",s),e.off("mouseup",c)},u=function(e){$("#left").css("width",n+e+"px"),$("#right").css("margin-left",n+r+e+"px")};return{restrict:"E",scope:{},replace:!0,controller:["$scope","$element",function(e,t){}],link:function(e,n,r){n.on("mousedown",a),t.state.sidebarWidth&&u(t.state.sidebarWidth)},template:'<div id="resize-bar"></div>'}}]),angular.module("directives").directive("draggable",function(){return{link:function(e,t,n){t.attr("draggable",!0),t[0].addEventListener("dragstart",function(t){e.$emit("dragstart"),window.isFF&&t.dataTransfer.setData("test","wtf")}),t[0].addEventListener("dragend",function(){e.$emit("dragend")})}}}),angular.module("directives").directive("droppable",function(){return{link:function(e,t,n){t[0].addEventListener("dragover",function(e){e.preventDefault()}),t[0].addEventListener("dragenter",function(t){t.preventDefault(),t.stopPropagation(),e.$emit("dragenter")}),t[0].addEventListener("dragleave",function(t){t.preventDefault(),t.stopPropagation(),e.$emit("dragleave")}),t[0].addEventListener("drop",function(t){t.preventDefault(),t.stopPropagation(),e.$emit("drop")})}}}),angular.module("directives").directive("includeReplace",function(){return{restrict:"A",link:function(e,t,n){t.replaceWith(t.children())}}}),angular.module("app").service("PlaylistService",["api",function(e){var t="/playlists";this.list=function(){return e.get(t)},this.getRecords=function(n){return e.get(t+"/"+n+"/records")},this.create=function(n,r){return e.post(t,{name:n,records:r})},this.update=function(n,r){return e.post(t+"/"+n,{name:r})},this["delete"]=function(n){return angular.isArray(n)?e.post(t+"/delete",n):e["delete"](t+"/"+n)}}]);